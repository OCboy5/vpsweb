{% extends 'base.html' %}
{% block title %}Compare Translations - {{ poem.poem_title }} - VPSWeb Repository{% endblock %}

{% block content %}
<div id="page-content-wrapper" class="px-4 py-6">
    <!-- Breadcrumb -->
    <nav class="flex mb-6" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="/" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-primary-600">
                    Dashboard
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
                    <a href="/poems" class="ml-1 text-sm font-medium text-gray-700 hover:text-primary-600 md:ml-2">
                        Poems
                    </a>
                </div>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
                    <a href="/poems/{{ poem.id }}" class="ml-1 text-sm font-medium text-gray-700 hover:text-primary-600 md:ml-2">
                        {{ poem.poem_title }}
                    </a>
                </div>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
                    <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">Compare Translations</span>
                </div>
            </li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Compare Translations</h1>
        <p class="text-lg text-gray-600 mt-1">{{ poem.poem_title }} by {{ poem.poet_name }}</p>
    </div>

    <!-- Translation Selection Area -->
        <div id="translation-selection-area" class="mb-8 max-w-4xl mx-auto hidden">
            <div class="bg-white shadow-sm border border-gray-200 rounded-lg p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="translation1-select" class="block text-sm font-medium text-gray-700 mb-2">Compare Translation</label>
                        <select id="translation1-select" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"></select>
                    </div>
                    <div>
                        <label for="translation2-select" class="block text-sm font-medium text-gray-700 mb-2">With Translation</label>
                        <select id="translation2-select" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"></select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Wide Comparison Grid -->
    <div id="wide-layout-wrapper">
        <div id="comparison-container" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Original Poem Column -->
            <div class="flex flex-col bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden">
                <!-- Header -->
                <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200 relative min-h-[85px]">
                    <div class="absolute top-4 right-4 text-right">
                        <div class="mb-1">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-700">{{ poem.source_language }}</span>
                        </div>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-700">Original</span>
                    </div>
                    <h2 class="text-lg font-medium text-gray-900 mb-1 pr-16">
                        <span class="w-6 h-6 bg-gray-500 text-white rounded-full flex items-center justify-center text-xs font-medium mr-2 inline-flex">O</span>
                        {{ poem.poem_title }}
                    </h2>
                    <p class="text-sm text-gray-600 mb-2">by {{ poem.poet_name }}</p>
                </div>
                <!-- Scrollable Content -->
                <div class="sync-scroll flex-grow overflow-y-auto">
                    <div class="poetry-text-container p-6 text-gray-800 leading-relaxed font-serif text-base whitespace-pre">{{ poem.original_text | strip_leading_spaces }}</div>
                </div>

                <!-- BBR Section -->
                <div id="bbr-section" class="px-6 pt-4 border-t border-gray-200 hidden">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-semibold text-gray-900 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            BBR Report
                        </h4>
                        <div class="flex items-center space-x-1">
                            <button onclick="toggleBBRContent()" id="bbr-toggle-btn"
                                    class="inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                                Show
                            </button>
                        </div>
                    </div>

                    <!-- BBR Metadata -->
                    <div id="bbr-metadata" class="mb-3 grid grid-cols-2 gap-2 text-xs text-gray-600">
                        <div class="flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            <span id="bbr-model">N/A</span>
                        </div>
                        <div class="flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                            </svg>
                            <span id="bbr-tokens">N/A</span>
                        </div>
                    </div>

                    <!-- BBR Content - Collapsible -->
                    <div id="bbr-content" class="hidden">
                        <div class="bg-gray-50 p-3 rounded border border-gray-200">
                            <pre id="bbr-content-text" class="text-xs text-gray-600 bg-white p-2 rounded border overflow-auto max-h-32 whitespace-pre-wrap">Loading...</pre>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="px-6 pb-6 min-h-[80px] flex flex-col justify-center">
                    <div class="pt-4 border-t border-gray-200">
                        <div class="flex items-start justify-between text-sm w-full">
                            <div class="flex-shrink-0 mr-4">
                                <span class="text-gray-500 text-xs">ID:</span><br>
                                <span class="text-gray-500 text-xs break-all max-w-[200px]">{{ poem.id }}</span>
                            </div>
                            <div class="flex flex-col items-end space-y-1">
                                <button id="bbr-button" onclick="handleBBRButtonClick()"
                                        class="inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50">
                                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    <span id="bbr-button-text">Generate BBR</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Translation 1 Column -->
            <div id="col-1" class="flex flex-col bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden">
                <!-- Loading State -->
                <div class="p-6 text-center text-gray-400 flex items-center justify-center h-full"><div><svg class="mx-auto h-8 w-8 animate-spin text-gray-300 mb-3" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p>Loading...</p></div></div>
            </div>

            <!-- Translation 2 Column -->
            <div id="col-2" class="flex flex-col bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden">
                <!-- Loading State -->
                <div class="p-6 text-center text-gray-400 flex items-center justify-center h-full"><div><svg class="mx-auto h-8 w-8 animate-spin text-gray-300 mb-3" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p>Loading...</p></div></div>
            </div>
        </div>
    </div>
</div>

<script>
// Store original poem data for fallbacks
window.originalPoemTitle = '{{ poem.poem_title }}';
window.originalPoetName = '{{ poem.poet_name }}';

document.addEventListener('DOMContentLoaded', async function() {
    let allTranslations = [];
    const selectionArea = document.getElementById('translation-selection-area');
    const select1 = document.getElementById('translation1-select');
    const select2 = document.getElementById('translation2-select');

    async function initializeComparison() {
        try {
            const response = await fetch(`/api/v1/poems/{{ poem.id }}/translations`);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

            allTranslations = await response.json();

            if (!allTranslations || allTranslations.length === 0) {
                handleNoTranslations();
                return;
            }

            if (allTranslations.length > 1) {
                selectionArea.classList.remove('hidden');
            }
            populateSelects();
            renderColumns();
            initializeSyncScroll();
        } catch (error) {
            console.error("Failed to load translations:", error);
            handleErrorState(error);
        }
    }

    function populateSelects() {
        select1.innerHTML = '';
        select2.innerHTML = '<option value="">None</option>';

        allTranslations.forEach(t => {
            const date = new Date(t.created_at).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
            const time = new Date(t.created_at).toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
            const quality = t.quality_rating ? `(${t.quality_rating}/10)` : '';
            const translatorType = t.translator_type === 'ai' ? 'AI' : 'Human';

            // Create unique identifier from target_language + translator_type + created_at
            const uniqueId = `${t.target_language}-${translatorType}-${t.created_at}`;
            const optionText = `${t.target_language} ${translatorType} (${date} ${time})`;

            select1.add(new Option(optionText, uniqueId));
            select2.add(new Option(optionText, uniqueId));
        });

        if (allTranslations.length > 0) select1.value = `${allTranslations[0].target_language}-${allTranslations[0].translator_type === 'ai' ? 'AI' : 'Human'}-${allTranslations[0].created_at}`;
        if (allTranslations.length > 1) select2.value = `${allTranslations[1].target_language}-${allTranslations[1].translator_type === 'ai' ? 'AI' : 'Human'}-${allTranslations[1].created_at}`;
    }

    function renderColumns() {
        // Helper function to find translation by unique identifier
        function findTranslationByIdentifier(identifier) {
            if (!identifier) return null;
            return allTranslations.find(t =>
                `${t.target_language}-${t.translator_type === 'ai' ? 'AI' : 'Human'}-${t.created_at}` === identifier
            );
        }

        const translation1 = findTranslationByIdentifier(select1.value);
        const translation2 = findTranslationByIdentifier(select2.value);

        // Prevent selecting the same translation in both dropdowns
        if (translation1 && translation2 && translation1.id === translation2.id) {
            // Show warning and clear second selection
            select2.value = '';
            const warningDiv = document.createElement('div');
            warningDiv.className = 'bg-yellow-50 border border-yellow-200 text-yellow-800 px-3 py-2 rounded-md mb-4';
            warningDiv.innerHTML = '⚠️ Please select different translations to compare';
            warningDiv.id = 'duplicate-warning';

            const container = document.getElementById('comparison-container');
            const existingWarning = document.getElementById('duplicate-warning');
            if (existingWarning) existingWarning.remove();
            container.insertBefore(warningDiv, container.firstChild);

            return;
        } else {
            // Remove any existing warning
            const existingWarning = document.getElementById('duplicate-warning');
            if (existingWarning) existingWarning.remove();
        }

        document.getElementById('col-1').innerHTML = generateColumnHTML(translation1, 'blue', 1);
        document.getElementById('col-2').innerHTML = generateColumnHTML(translation2, 'emerald', 2);

        // Initialize slider colors after rendering
        setTimeout(() => {
            if (translation1) {
                const slider1 = document.getElementById(`quality-slider-${translation1.id}`);
                if (slider1) updateSliderColor(slider1, translation1.quality_rating || 0);

                // Load human notes buttons for human translations
                if (translation1.translator_type === 'human') {
                    loadHumanNotesButton(translation1.id);
                }
            }
            if (translation2) {
                const slider2 = document.getElementById(`quality-slider-${translation2.id}`);
                if (slider2) updateSliderColor(slider2, translation2.quality_rating || 0);

                // Load human notes buttons for human translations
                if (translation2.translator_type === 'human') {
                    loadHumanNotesButton(translation2.id);
                }
            }
        }, 100);
    }

    select1.addEventListener('change', renderColumns);
    select2.addEventListener('change', renderColumns);

    await initializeComparison();
});

function handleNoTranslations() {
    const container = document.getElementById('comparison-container');
    container.innerHTML = `<div class="lg:col-span-3 text-center py-16 bg-white rounded-lg shadow-sm border"><h3 class="text-lg font-medium text-gray-900 mb-2">No Translations Available</h3><p class="text-gray-500 mb-6">This poem doesn't have any translations to compare yet.</p><a href="/poems/{{ poem.id }}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">Add First Translation</a></div>`;
}

function handleErrorState(error) {
    document.getElementById('col-1').innerHTML = `<div class="p-6 text-center text-red-500">Failed to load translation data.</div>`;
    document.getElementById('col-2').innerHTML = `<div class="p-6 text-center text-red-500">Failed to load translation data.</div>`;
}

function generateColumnHTML(translation, color, colNum) {
    if (!translation) {
        return `<div class="p-6 text-center text-gray-400 flex items-center justify-center h-full"><div><svg class="mx-auto h-12 w-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg><p>No translation selected</p></div></div>`;
    }

    const typeClass = translation.translator_type === 'ai' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800';
    const notesLink = translation.translator_type === 'ai' ?
        `<a href="/translations/${translation.id}/notes" class="text-sm text-blue-600 hover:text-blue-500 font-medium text-right whitespace-nowrap">Translation<br>Notes</a>` :
        `<span id="notes-link-${translation.id}" class="text-right whitespace-nowrap">
            <!-- Human notes link will be dynamically loaded here -->
         </span>`;

    return `
        <div class="bg-gradient-to-r from-${color}-50 to-${color}-100 px-6 py-4 border-b border-gray-200 relative min-h-[85px]">
            <div class="absolute top-4 right-4 text-right">
                <div class="mb-1">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-${color}-200 text-${color}-800">${translation.target_language}</span>
                </div>
                ${translation.translator_type === 'human' && translation.translator_info ? `
                <div class="mb-1">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">${translation.translator_info}</span>
                </div>
                ` : ''}
                ${translation.workflow_mode ? `
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">${translation.workflow_mode}</span>
                ` : ''}
            </div>
            <h2 class="text-lg font-medium text-gray-900 mb-1 pr-16">
                <span class="w-6 h-6 bg-${color}-500 text-white rounded-full flex items-center justify-center text-xs font-medium mr-2 inline-flex">${colNum}</span>
                ${translation.translated_poem_title || translation.poem_title || window.originalPoemTitle}
            </h2>
            <p class="text-sm text-gray-600 mb-2">by ${translation.translated_poet_name || translation.poet_name || window.originalPoetName}</p>
        </div>
        <div class="sync-scroll flex-grow overflow-y-auto">
            <div class="poetry-text-container p-6 text-gray-800 leading-relaxed font-serif text-base whitespace-pre">${translation.translated_text.trimStart()}</div>
        </div>
        <div class="px-6 pb-6 min-h-[80px] flex flex-col justify-center">
            <div class="pt-4 border-t border-gray-200">
                <div class="flex items-start justify-between text-sm w-full">
                    <div class="flex-shrink-0 mr-4">
                        <span class="text-gray-500 text-xs">ID:</span><br>
                        <span class="text-gray-500 text-xs break-all max-w-[200px]">${translation.id}</span>
                    </div>
                    <div class="flex-shrink-0 ml-auto">
                        ${notesLink}
                    </div>
                </div>

                <!-- Quality Rating Section -->
                <div class="mt-2 pt-2 border-t border-gray-200 flex items-center">
                    <div class="flex items-center justify-between w-full">
                        <span class="text-sm font-medium text-gray-700">Rating:</span>
                        <div class="flex items-center space-x-2">
                            <input type="range"
                                   id="quality-slider-${translation.id}"
                                   class="w-24 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                                   min="0"
                                   max="10"
                                   value="${translation.quality_rating || 0}"
                                   oninput="updateRatingDisplay('${translation.id}', this.value)"
                                   onchange="updateQualityRating('${translation.id}', this.value)">
                            <span id="rating-display-${translation.id}" class="text-sm font-medium text-gray-700 min-w-[40px] text-right">
                                ${(translation.quality_rating && translation.quality_rating > 0) ? translation.quality_rating + '/10' : 'Unrated'}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// initializeSyncScroll function is now in common.js

function updateRatingDisplay(translationId, rating) {
    const displayElement = document.getElementById(`rating-display-${translationId}`);
    const sliderElement = document.getElementById(`quality-slider-${translationId}`);

    // Update display immediately for real-time feedback
    if (rating == 0) {
        displayElement.textContent = 'Unrated';
    } else {
        displayElement.textContent = `${rating}/10`;
    }

    // Update slider color based on rating
    updateSliderColor(sliderElement, rating);
}

function updateSliderColor(sliderElement, rating) {
    let color;
    if (rating == 0) {
        color = '#e5e7eb'; // gray-200 for unrated
    } else if (rating <= 3) {
        color = '#ef4444'; // red-500 for poor (1-3)
    } else if (rating <= 5) {
        color = '#f59e0b'; // amber-500 for fair (4-5)
    } else if (rating <= 7) {
        color = '#3b82f6'; // blue-500 for good (6-7)
    } else {
        color = '#10b981'; // emerald-500 for excellent (8-10)
    }

    // Update slider track background
    const percentage = (rating / 10) * 100;
    sliderElement.style.background = `linear-gradient(to right, ${color} 0%, ${color} ${percentage}%, #e5e7eb ${percentage}%, #e5e7eb 100%)`;
}

async function updateQualityRating(translationId, rating) {
    const displayElement = document.getElementById(`rating-display-${translationId}`);
    const sliderElement = document.getElementById(`quality-slider-${translationId}`);

    try {
        const response = await fetch(`/api/v1/translations/${translationId}/quality`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quality_rating: parseInt(rating)
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const result = await response.json();
        console.log('Quality rating updated successfully:', result);

        // Show a brief success indicator
        displayElement.classList.add('text-green-600');
        setTimeout(() => {
            displayElement.classList.remove('text-green-600');
        }, 1000);

    } catch (error) {
        console.error('Failed to update quality rating:', error);

        // Revert UI changes on error
        displayElement.classList.add('text-red-600');
        setTimeout(() => {
            displayElement.classList.remove('text-red-600');
        }, 2000);

        // Show error message
        alert('Failed to save quality rating. Please try again.');
    }
}

// Load human notes button functionality for compare page
async function loadHumanNotesButton(translationId) {
    try {
        const response = await fetch(`/api/v1/translations/${translationId}/human-notes`);
        if (response.ok) {
            const data = await response.json();
            const notesContainer = document.getElementById(`notes-link-${translationId}`);

            if (data.success && data.count > 0) {
                // Show "Translation Notes" button with count
                notesContainer.innerHTML = `<a href="/translations/${translationId}/human-notes" class="text-sm text-purple-600 hover:text-purple-500 font-medium whitespace-nowrap">Translation<br>Notes (${data.count})</a>`;
            } else {
                // No notes, hide the container
                notesContainer.innerHTML = '';
            }
        }
    } catch (error) {
        console.error('Failed to load human notes:', error);
        // If there's an error, leave the container empty
        const notesContainer = document.getElementById(`notes-link-${translationId}`);
        if (notesContainer) {
            notesContainer.innerHTML = '';
        }
    }
}

// --- BBR FUNCTIONS ---
// Poem data for BBR operations
const poemId = "{{ poem.id }}";
// currentBBR is now declared in common.js

// Initialize BBR on page load
document.addEventListener('DOMContentLoaded', function() {
    loadBBRStatus();
});

async function loadBBRStatus() {
    try {
        const response = await fetch(`/api/v1/poems/${poemId}`);
        if (response.ok) {
            const poem = await response.json();
            updateBBRButton(poem.has_bbr);

            if (poem.has_bbr) {
                await loadBBRData();
            }
        }
    } catch (error) {
        console.error('Error loading BBR status:', error);
    }
}

function updateBBRButton(hasBBR) {
    const bbrButton = document.getElementById('bbr-button');
    const bbrButtonText = document.getElementById('bbr-button-text');

    if (hasBBR) {
        // Show "View BBR" button
        bbrButtonText.textContent = 'View BBR';
        bbrButton.className = bbrButton.className.replace(
            'text-gray-700 bg-white hover:bg-gray-50',
            'text-blue-700 bg-blue-600 hover:bg-blue-700'
        );
    } else {
        // Show "Generate BBR" button
        bbrButtonText.textContent = 'Generate BBR';
        bbrButton.className = bbrButton.className.replace(
            'text-blue-700 bg-blue-600 hover:bg-blue-700',
            'text-gray-700 bg-white hover:bg-gray-50'
        );
    }
}

async function handleBBRButtonClick() {
    const bbrButton = document.getElementById('bbr-button');
    const bbrButtonText = document.getElementById('bbr-button-text');

    if (bbrButtonText.textContent === 'Generate BBR') {
        // Generate new BBR (keeping existing functionality for generation)
        await generateBBR();
    } else {
        // View existing BBR - use modal like translation notes page
        await viewBBRInModal();
    }
}

// View BBR in modal (same as translation notes page)
async function viewBBRInModal() {
    try {
        const response = await fetch(`/api/v1/poems/${poemId}/bbr`);

        if (response.ok) {
            const result = await response.json();
            // BBR data is nested under result.data
            if (result.data && result.data.has_bbr && result.data.bbr) {
                showBBRModal(result.data.bbr);
            } else {
                showNotification('No Background Briefing Report found for this poem', 'error');
            }
        } else {
            showNotification('Failed to load Background Briefing Report', 'error');
        }
    } catch (error) {
        console.error('Error viewing BBR:', error);
        showNotification('Error loading Background Briefing Report', 'error');
    }
}

// BBR Modal functions are now in common.js

async function generateBBR() {
    const bbrButton = document.getElementById('bbr-button');
    const bbrButtonText = document.getElementById('bbr-button-text');

    try {
        // Show loading state
        bbrButton.disabled = true;
        bbrButtonText.textContent = 'Generating...';
        bbrButton.className = bbrButton.className.replace(/hover:bg-\w+-\d+/g, 'opacity-75 cursor-not-allowed');

        const response = await fetch(`/api/v1/poems/${poemId}/bbr/generate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();

        if (response.ok) {
            showNotification('Background Briefing Report generated successfully', 'success');
            await loadBBRStatus(); // Reload status and data
        } else {
            showNotification(result.detail || 'Failed to generate BBR', 'error');
        }
    } catch (error) {
        console.error('Error generating BBR:', error);
        showNotification('Error generating Background Briefing Report', 'error');
    } finally {
        // Restore button state
        bbrButton.disabled = false;
        updateBBRButton(bbrButtonText.textContent !== 'Generate BBR');
    }
}

async function loadBBRData() {
    try {
        const response = await fetch(`/api/v1/poems/${poemId}/bbr`);

        if (response.ok) {
            const result = await response.json();
            if (result.has_bbr && result.bbr) {
                currentBBR = result.bbr;
                showBBRSection(result.bbr);
            }
        } else {
            showNotification('Failed to load Background Briefing Report', 'error');
        }
    } catch (error) {
        console.error('Error loading BBR:', error);
        showNotification('Error loading Background Briefing Report', 'error');
    }
}

function showBBRSection(bbr) {
    const bbrSection = document.getElementById('bbr-section');

    // Update metadata
    const modelInfo = JSON.parse(bbr.model_info || '{}');
    document.getElementById('bbr-model').textContent = modelInfo.model || 'N/A';
    document.getElementById('bbr-tokens').textContent = bbr.tokens_used || 'N/A';

    // Update content
    try {
        const parsedContent = JSON.parse(bbr.content);
        document.getElementById('bbr-content-text').textContent = JSON.stringify(parsedContent, null, 2);
    } catch (e) {
        document.getElementById('bbr-content-text').textContent = bbr.content;
    }

    // Show section
    bbrSection.classList.remove('hidden');
}

function toggleBBRContent() {
    const bbrContent = document.getElementById('bbr-content');
    const toggleBtn = document.getElementById('bbr-toggle-btn');
    const isHidden = bbrContent.classList.contains('hidden');

    if (isHidden) {
        bbrContent.classList.remove('hidden');
        toggleBtn.innerHTML = `
            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
            </svg>
            Hide
        `;
    } else {
        bbrContent.classList.add('hidden');
        toggleBtn.innerHTML = `
            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
            Show
        `;
    }
}

// showNotification function is now in common.js
</script>

<style>
.poetry-text-container {
    width: max-content;
    min-width: 100%;
}

/* --- NEW, CORRECT RULES (LEARNED FROM YOUR WORKING FILE) --- */
#wide-layout-wrapper {
  /* This is the breakout container. It breaks out and centers its child. */
  width: 100vw;
  position: relative;
  left: 50%;
  transform: translateX(-50%);
  display: grid;
  place-items: center;
  padding: 0 2rem; /* Adds padding to the left/right of the breakout area */
}

#comparison-container {
  /* This is the grid itself. It's told to be exactly as wide as its content. */
  width: max-content;
}

body {
    overflow-x: auto;
}

.sync-scroll {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
}
.sync-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
.sync-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
.sync-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
.sync-scroll::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

/* Quality Rating Slider Styles */
.slider {
    -webkit-appearance: none;
    appearance: none;
    background: #e5e7eb;
    height: 6px;
    border-radius: 3px;
    outline: none;
    cursor: pointer;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    background: #3b82f6;
    border: 2px solid #3b82f6;
    height: 14px;
    width: 14px;
    border-radius: 50%;
    margin-top: -5px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

.slider::-moz-range-thumb {
    background: #3b82f6;
    border: 2px solid #3b82f6;
    height: 14px;
    width: 14px;
    border-radius: 50%;
    margin-top: -5px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.slider::-moz-range-thumb:hover {
    transform: scale(1.2);
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}
</style>
{% endblock %}