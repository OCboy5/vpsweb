{% extends 'base.html' %}
{% block title %}Compare Translations - {{ poem.poem_title }} - VPSWeb Repository{% endblock %}

{% block content %}
<div class="px-4 py-6 max-w-full mx-auto">
    <!-- Breadcrumb -->
    <nav class="flex mb-6" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="/" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-primary-600">
                    Dashboard
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
                    <a href="/poems" class="ml-1 text-sm font-medium text-gray-700 hover:text-primary-600 md:ml-2">
                        Poems
                    </a>
                </div>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
                    <a href="/poems/{{ poem.id }}" class="ml-1 text-sm font-medium text-gray-700 hover:text-primary-600 md:ml-2">
                        {{ poem.poem_title }}
                    </a>
                </div>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
                    <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">Compare Translations</span>
                </div>
            </li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Compare Translations</h1>
        <p class="text-lg text-gray-600 mt-1">{{ poem.poem_title }} by {{ poem.poet_name }}</p>
    </div>

    <!-- Translation Selection Area -->
    <div id="translation-selection-area" class="mb-8 max-w-4xl mx-auto hidden">
        <div class="bg-white shadow-sm border border-gray-200 rounded-lg p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="translation1-select" class="block text-sm font-medium text-gray-700 mb-2">Compare Translation</label>
                    <select id="translation1-select" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"></select>
                </div>
                <div>
                    <label for="translation2-select" class="block text-sm font-medium text-gray-700 mb-2">With Translation</label>
                    <select id="translation2-select" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"></select>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparison Grid -->
    <div id="comparison-container" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Original Poem Column -->
        <div class="flex flex-col bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200 relative min-h-[93px]">
                <div class="absolute top-4 right-4 text-right">
                    <div class="mb-1">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-700">{{ poem.source_language }}</span>
                    </div>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-700">Original</span>
                </div>
                <h2 class="text-lg font-medium text-gray-900 mb-1 pr-16">
                    <span class="w-6 h-6 bg-gray-500 text-white rounded-full flex items-center justify-center text-xs font-medium mr-2 inline-flex">O</span>
                    {{ poem.poem_title }}
                </h2>
                <p class="text-sm text-gray-600 mb-2">by {{ poem.poet_name }}</p>
            </div>
            <!-- Scrollable Content -->
            <div class="sync-scroll flex-grow overflow-y-auto">
                <div class="poetry-text-container p-6 text-gray-800 leading-relaxed font-serif text-base whitespace-pre">{{ poem.original_text | strip_leading_spaces }}</div>
            </div>
            <!-- Footer -->
            <div class="px-6 pb-6 min-h-[100px] flex flex-col justify-center">
                <div class="pt-4 border-t border-gray-200">
                    <div class="flex items-start justify-between text-sm w-full">
                        <div class="flex-shrink-0 mr-4">
                            <span class="text-gray-500 text-xs">ID:</span><br>
                            <span class="text-gray-500 text-xs break-all max-w-[200px]">{{ poem.id }}</span>
                        </div>
                        <div class="invisible text-sm font-medium whitespace-nowrap">Original Poem</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Translation 1 Column -->
        <div id="col-1" class="flex flex-col bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden">
            <!-- Loading State -->
            <div class="p-6 text-center text-gray-400 flex items-center justify-center h-full"><div><svg class="mx-auto h-8 w-8 animate-spin text-gray-300 mb-3" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p>Loading...</p></div></div>
        </div>

        <!-- Translation 2 Column -->
        <div id="col-2" class="flex flex-col bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden">
            <!-- Loading State -->
            <div class="p-6 text-center text-gray-400 flex items-center justify-center h-full"><div><svg class="mx-auto h-8 w-8 animate-spin text-gray-300 mb-3" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p>Loading...</p></div></div>
        </div>
    </div>
</div>

<script>
// Store original poem data for fallbacks
window.originalPoemTitle = '{{ poem.poem_title }}';
window.originalPoetName = '{{ poem.poet_name }}';

document.addEventListener('DOMContentLoaded', async function() {
    let allTranslations = [];
    const selectionArea = document.getElementById('translation-selection-area');
    const select1 = document.getElementById('translation1-select');
    const select2 = document.getElementById('translation2-select');

    async function initializeComparison() {
        try {
            const response = await fetch(`/api/v1/poems/{{ poem.id }}/translations`);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            
            allTranslations = await response.json();
            
            if (!allTranslations || allTranslations.length === 0) {
                handleNoTranslations();
                return;
            }

            if (allTranslations.length > 1) {
                selectionArea.classList.remove('hidden');
            }
            populateSelects();
            renderColumns();
            initializeSyncScroll();
        } catch (error) {
            console.error("Failed to load translations:", error);
            handleErrorState(error);
        }
    }

    function populateSelects() {
        select1.innerHTML = '';
        select2.innerHTML = '<option value="">None</option>';

        allTranslations.forEach(t => {
            const date = new Date(t.created_at).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
            const quality = t.quality_rating ? `(${t.quality_rating}/5)` : '';
            const optionText = `${t.target_language} - ${t.translator_info} ${quality} (${date})`;
            
            select1.add(new Option(optionText, t.id));
            select2.add(new Option(optionText, t.id));
        });

        if (allTranslations.length > 0) select1.value = allTranslations[0].id;
        if (allTranslations.length > 1) select2.value = allTranslations[1].id;
    }

    function renderColumns() {
        const id1 = allTranslations.length > 0 ? (select1.value || allTranslations[0].id) : null;
        const id2 = select2.value;

        const translation1 = id1 ? allTranslations.find(t => t.id === id1) : null;
        const translation2 = id2 ? allTranslations.find(t => t.id === id2) : null;

        document.getElementById('col-1').innerHTML = generateColumnHTML(translation1, 'blue', 1);
        document.getElementById('col-2').innerHTML = generateColumnHTML(translation2, 'emerald', 2);
    }
    
    select1.addEventListener('change', renderColumns);
    select2.addEventListener('change', renderColumns);

    await initializeComparison();
});

function handleNoTranslations() {
    const container = document.getElementById('comparison-container');
    container.innerHTML = `<div class="lg:col-span-3 text-center py-16 bg-white rounded-lg shadow-sm border"><h3 class="text-lg font-medium text-gray-900 mb-2">No Translations Available</h3><p class="text-gray-500 mb-6">This poem doesn't have any translations to compare yet.</p><a href="/poems/{{ poem.id }}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">Add First Translation</a></div>`;
}

function handleErrorState(error) {
    document.getElementById('col-1').innerHTML = `<div class="p-6 text-center text-red-500">Failed to load translation data.</div>`;
    document.getElementById('col-2').innerHTML = `<div class="p-6 text-center text-red-500">Failed to load translation data.</div>`;
}

function generateColumnHTML(translation, color, colNum) {
    if (!translation) {
        return `<div class="p-6 text-center text-gray-400 flex items-center justify-center h-full"><div><svg class="mx-auto h-12 w-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg><p>No translation selected</p></div></div>`;
    }

    const typeClass = translation.translator_type === 'AI' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800';
    const notesLink = `<a href="/translations/${translation.id}/notes" class="text-sm text-blue-600 hover:text-blue-500 font-medium text-right whitespace-nowrap">Translation<br>Notes</a>`;

    return `
        <div class="bg-gradient-to-r from-${color}-50 to-${color}-100 px-6 py-4 border-b border-gray-200 relative min-h-[93px]">
            <div class="absolute top-4 right-4 text-right">
                <div class="mb-1">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-${color}-200 text-${color}-800">${translation.target_language}</span>
                </div>
                ${translation.workflow_mode ? `
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">${translation.workflow_mode}</span>
                ` : ''}
            </div>
            <h2 class="text-lg font-medium text-gray-900 mb-1 pr-16">
                <span class="w-6 h-6 bg-${color}-500 text-white rounded-full flex items-center justify-center text-xs font-medium mr-2 inline-flex">${colNum}</span>
                ${translation.translated_poem_title || translation.poem_title || window.originalPoemTitle}
            </h2>
            <p class="text-sm text-gray-600 mb-2">by ${translation.translated_poet_name || translation.poet_name || window.originalPoetName}</p>
        </div>
        <div class="sync-scroll flex-grow overflow-y-auto">
            <div class="poetry-text-container p-6 text-gray-800 leading-relaxed font-serif text-base whitespace-pre">${translation.translated_text.trimStart()}</div>
        </div>
        <div class="px-6 pb-6 min-h-[100px] flex flex-col justify-center">
            <div class="pt-4 border-t border-gray-200">
                <div class="flex items-start justify-between text-sm w-full">
                    <div class="flex-shrink-0 mr-4">
                        <span class="text-gray-500 text-xs">ID:</span><br>
                        <span class="text-gray-500 text-xs break-all max-w-[200px]">${translation.id}</span>
                    </div>
                    <div class="flex-shrink-0 ml-auto">
                        ${notesLink}
                    </div>
                </div>
            </div>
        </div>
    `;
}

function initializeSyncScroll() {
    const scrollableElements = document.querySelectorAll('.sync-scroll');
    let isSyncing = false;

    scrollableElements.forEach(element => {
        element.addEventListener('scroll', event => {
            if (isSyncing) return;
            isSyncing = true;
            const sourceElement = event.target;
            const scrollPercentage = sourceElement.scrollTop / (sourceElement.scrollHeight - sourceElement.clientHeight);

            scrollableElements.forEach(targetElement => {
                if (targetElement !== sourceElement) {
                    const targetScrollableHeight = targetElement.scrollHeight - targetElement.clientHeight;
                    if (targetScrollableHeight > 0) { // Avoid division by zero
                        targetElement.scrollTop = targetScrollableHeight * scrollPercentage;
                    }
                }
            });
            requestAnimationFrame(() => { isSyncing = false; });
        });
    });
}
</script>

<style>
.poetry-text-container {
    width: max-content;
    min-width: 100%;
}
.sync-scroll {
    scrollbar-width: thin;
    scrollbar-color: #a8a8a8 #f1f1f1;
}
.sync-scroll::-webkit-scrollbar { width: 8px; }
.sync-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
.sync-scroll::-webkit-scrollbar-thumb { background: #a8a8a8; border-radius: 4px; }
.sync-scroll::-webkit-scrollbar-thumb:hover { background: #7a7a7a; }
</style>
{% endblock %}