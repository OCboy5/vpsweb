{% extends 'base.html' %}
{% block title %}Translation Notes - {{ poem.poem_title }} - VPSWeb Repository{% endblock %}

{% block content %}
<div id="page-content-wrapper" class="px-4 py-6">
    <!-- Breadcrumb with Layout Toggle Buttons -->
    <nav class="flex mb-6 justify-between items-center" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="/" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-primary-600">
                    Dashboard
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                    </svg>
                    <a href="/poems" class="ml-1 text-sm font-medium text-gray-700 hover:text-primary-600 md:ml-2">
                        Poems
                    </a>
                </div>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                    </svg>
                    <a href="/poems/{{ poem.id }}" class="ml-1 text-sm font-medium text-gray-700 hover:text-primary-600 md:ml-2">
                        {{ poem.poem_title }}
                    </a>
                </div>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                    </svg>
                    <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">Translation Notes</span>
                </div>
            </li>
        </ol>

        <!-- Layout Toggle Buttons - Right Aligned in Navigation -->
        <div class="flex bg-indigo-100 rounded-lg p-1 shadow-lg">
            <button id="layout2-btn" class="layout-toggle-btn px-4 py-2 text-sm font-bold rounded-md bg-indigo-600 text-white shadow-md transition-all duration-200 hover:bg-indigo-700 hover:shadow-lg">
                Wide
            </button>
            <button id="layout1-btn" class="layout-toggle-btn px-4 py-2 text-sm font-bold rounded-md text-indigo-700 hover:text-indigo-900 transition-all duration-200">
                Long
            </button>
        </div>
    </nav>

    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Translation Notes</h1>
                <p class="mt-2 text-sm text-gray-600">
                    Follow the complete T-E-T (Translator→Editor→Translator) workflow evolution
                </p>
                {% if translation.translator_type.lower() == 'ai' and workflow_steps %}
                    {% set initial_step = workflow_steps | selectattr('step_type', 'equalto', 'initial_translation') | first %}
                    {% set editor_step = workflow_steps | selectattr('step_type', 'equalto', 'editor_review') | first %}
                    {% set revised_step = workflow_steps | selectattr('step_type', 'equalto', 'revised_translation') | first %}

                    {% set initial_model = initial_step.model_name if initial_step else 'Unknown' %}
                    {% set editor_model = editor_step.model_name if editor_step else 'Unknown' %}
                    {% set revised_model = revised_step.model_name if revised_step else 'Unknown' %}

                    {% set workflow_mode = initial_step.workflow_mode if initial_step else 'Unknown' %}

                    <p class="mt-1 text-xs text-gray-500 font-mono">
                        {{ workflow_mode }}: {{ initial_model }} → {{ editor_model }} → {{ revised_model }}
                    </p>
                {% endif %}
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <div class="text-sm font-medium text-gray-900">{{ poem.poet_name }}</div>
                    <div class="text-xs text-gray-500">{{ poem.source_language }} → {{ translation.target_language }}</div>
                </div>
                {% if translation.translator_type.lower() == 'ai' %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    AI Translation
                </span>
                {% else %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    Human Translation
                </span>
                {% endif %}
            </div>
        </div>
    </div>

  
    <!-- Layout 1: Original Sequential Layout (Completely Independent) -->
<div id="layout1" class="layout-container hidden">
    <!-- Original Poem (Hero Section) -->
    <section id="original-poem" class="mb-12">
        <div class="step-header flex items-center justify-between mb-6">
            <div class="step-title">
                <h3 class="text-xl font-bold text-gray-900 flex items-center">
                    <div class="w-8 h-8 mr-3 rounded-full bg-gray-100 flex items-center justify-center">
                        <span class="text-sm font-medium text-gray-700">0</span>
                    </div>
                    Original Poem
                </h3>
                <p class="text-sm text-gray-500 mt-1">Source text in {{ poem.source_language }}</p>
            </div>
        </div>

        <div class="bg-white shadow-lg rounded-lg p-8 border border-gray-100">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">{{ poem.poem_title }}</h2>
                    <p class="text-sm text-gray-500">by {{ poem.poet_name }}</p>
                </div>
                <div class="flex items-center space-x-2 text-sm text-gray-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 8 5z"/>
                    </svg>
                    <span>{{ poem.source_language }}</span>
                </div>
            </div>
            <div class="poetry-text text-gray-800 max-w-4xl mx-auto text-left">{{ poem.original_text | strip_leading_spaces | safe }}</div>
        </div>
    </section>

    <!-- Workflow Steps Container -->
    <div id="workflow-steps" class="space-y-8 max-w-5xl mx-auto">
        {% if translation.translator_type.lower() == 'ai' and workflow_steps %}
            <!-- Get workflow steps by filtering the steps list -->
            {% set initial_step = workflow_steps | selectattr('step_type', 'equalto', 'initial_translation') | first %}
            {% set editor_step = workflow_steps | selectattr('step_type', 'equalto', 'editor_review') | first %}
            {% set revised_step = workflow_steps | selectattr('step_type', 'equalto', 'revised_translation') | first %}

            <!-- Step 1: Initial Translation -->
            {% if initial_step %}
            <section id="step-initial-translation" class="workflow-step-card mb-12">
                <div class="step-header flex items-center justify-between mb-6">
                    <div class="step-title">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <div class="w-8 h-8 mr-3 rounded-full bg-blue-100 flex items-center justify-center">
                                <span class="text-sm font-medium text-blue-700">1</span>
                            </div>
                            Initial Translation
                        </h3>
                        <p class="text-sm text-gray-500 mt-1">First draft created by AI translator</p>
                    </div>
                    <div class="step-metrics flex space-x-4 text-sm">
                        {% if initial_step.tokens_used %}
                        <div class="flex items-center text-gray-600">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                            </svg>
                            {{ initial_step.tokens_used }} tokens
                        </div>
                        {% endif %}
                        {% if initial_step.duration_seconds %}
                        <div class="flex items-center text-gray-600">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            {{ "%.1f"|format(initial_step.duration_seconds) }}s
                        </div>
                        {% endif %}
                        {% if initial_step.cost %}
                        <div class="flex items-center text-gray-600">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3-2-1.343-2-3-2zm0 8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v2m0-6h.01M16 13h.01"/>
                            </svg>
                            ¥{{ "%.6f"|format(initial_step.cost) }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="bg-white shadow-lg rounded-lg p-8 border border-gray-100">
                    <div class="mb-6">
                        {% if initial_step.translated_title %}
                        <h2 class="text-2xl font-bold text-gray-900">{{ initial_step.translated_title }}</h2>
                        {% else %}
                        <h2 class="text-2xl font-bold text-gray-900">Initial Translation</h2>
                        {% endif %}
                        {% if initial_step.translated_poet_name %}
                        <p class="text-sm text-gray-500">by {{ initial_step.translated_poet_name }}</p>
                        {% else %}
                        <p class="text-sm text-gray-500">Initial Translation</p>
                        {% endif %}
                    </div>
                    <div class="poetry-text text-gray-800 max-w-4xl mx-auto text-left">{{ initial_step.content | strip_leading_spaces | safe }}</div>
                </div>

                <!-- Translator Notes -->
                {% if initial_step.notes %}
                <div class="mt-6 p-6 bg-gray-50 rounded-lg border border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-900 mb-2">Translator's Notes</h4>
                    <div class="text-sm text-gray-700 leading-relaxed notes-content">
                        {{ initial_step.notes | safe }}
                    </div>
                </div>
                {% endif %}
            </section>
            {% endif %}

            <!-- Step 2: Editor Review -->
            {% if editor_step %}
            <section id="step-editor-review" class="workflow-step-card mb-12">
                <div class="step-header flex items-center justify-between mb-6">
                    <div class="step-title">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <div class="w-8 h-8 mr-3 rounded-full bg-orange-100 flex items-center justify-center">
                                <span class="text-sm font-medium text-orange-700">2</span>
                            </div>
                            Editor Review
                        </h3>
                        <p class="text-sm text-gray-500 mt-1">Quality assessment and improvement suggestions</p>
                    </div>
                    <div class="step-metrics flex space-x-4 text-sm">
                        {% if editor_step.tokens_used %}
                        <div class="flex items-center text-gray-600">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                            </svg>
                            {{ editor_step.tokens_used }} tokens
                        </div>
                        {% endif %}
                        {% if editor_step.duration_seconds %}
                        <div class="flex items-center text-gray-600">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            {{ "%.1f"|format(editor_step.duration_seconds) }}s
                        </div>
                        {% endif %}
                        {% if editor_step.cost %}
                        <div class="flex items-center text-gray-600">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3-2-1.343-2-3-2zm0 8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v2m0-6h.01M16 13h.01"/>
                            </svg>
                            ¥{{ "%.6f"|format(editor_step.cost) }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="p-6 bg-orange-50 rounded-lg border border-orange-200">
                    <div class="text-sm text-gray-700 leading-relaxed notes-content">
                        {{ editor_step.content | strip_leading_spaces | safe }}
                    </div>
                </div>
            </section>
            {% endif %}

            <!-- Step 3: Revised Translation -->
            {% if revised_step %}
            <section id="step-revised-translation" class="workflow-step-card mb-12">
                <div class="step-header flex items-center justify-between mb-6">
                    <div class="step-title">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <div class="w-8 h-8 mr-3 rounded-full bg-green-100 flex items-center justify-center">
                                <span class="text-sm font-medium text-green-700">3</span>
                            </div>
                            Final Translation
                        </h3>
                        <p class="text-sm text-gray-500 mt-1">Polished translation incorporating editor feedback</p>
                    </div>
                    <div class="step-metrics flex space-x-4 text-sm">
                        {% if revised_step.tokens_used %}
                        <div class="flex items-center text-gray-600">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                            </svg>
                            {{ revised_step.tokens_used }} tokens
                        </div>
                        {% endif %}
                        {% if revised_step.duration_seconds %}
                        <div class="flex items-center text-gray-600">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            {{ "%.1f"|format(revised_step.duration_seconds) }}s
                        </div>
                        {% endif %}
                        {% if revised_step.cost %}
                        <div class="flex items-center text-gray-600">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3-2-1.343-2-3-2zm0 8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v2m0-6h.01M16 13h.01"/>
                            </svg>
                            ¥{{ "%.6f"|format(revised_step.cost) }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="bg-white shadow-lg rounded-lg p-8 border border-gray-100">
                    <div class="mb-6">
                        {% if revised_step.translated_title %}
                        <h2 class="text-2xl font-bold text-gray-900">{{ revised_step.translated_title }}</h2>
                        {% else %}
                        <h2 class="text-2xl font-bold text-gray-900">Final Translation</h2>
                        {% endif %}
                        {% if revised_step.translated_poet_name %}
                        <p class="text-sm text-gray-500">by {{ revised_step.translated_poet_name }}</p>
                        {% else %}
                        <p class="text-sm text-gray-500">Final Translation</p>
                        {% endif %}
                    </div>
                    <div class="poetry-text text-gray-800 max-w-4xl mx-auto text-left">{{ revised_step.content | strip_leading_spaces | safe }}</div>
                </div>

                <!-- Revision Notes -->
                {% if revised_step.notes %}
                <div class="mt-6 p-6 bg-green-50 rounded-lg border border-green-200">
                    <h4 class="text-lg font-semibold text-gray-900 mb-2">Revision Notes</h4>
                    <div class="text-sm text-green-800 leading-relaxed notes-content">
                        {{ revised_step.notes | safe }}
                    </div>
                </div>
                {% endif %}
            </section>
            {% endif %}

        {% else %}
            <!-- Human Translation or No Workflow Data -->
            <section class="bg-white shadow-lg rounded-lg p-8 border border-gray-100">
                <div class="text-center">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">
                        {% if translation.translator_type.lower() == 'human' %}
                        Human Translation
                        {% else %}
                        Workflow Details Not Available
                        {% endif %}
                    </h3>
                    <p class="text-gray-600 max-w-2xl mx-auto">
                        {% if translation.translator_type.lower() == 'human' %}
                        This is a human translation created by {{ translation.translator_info }}.
                        Detailed workflow steps are only available for AI translations.
                        {% else %}
                        Detailed workflow steps are not available for this translation.
                        This might be due to the translation being created before workflow tracking was implemented.
                        {% endif %}
                    </p>
                    <div class="mt-6">
                        <a href="/poems/{{ poem.id }}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                            </svg>
                            Back to Poem
                        </a>
                    </div>
                </div>
            </section>
        {% endif %}
    </div>
</div>

<!-- Layout 2: Elegant 4-Column Evolution Layout -->
<div id="layout2" class="layout-container">
    <div id="comparison-container" class="grid grid-cols-1 lg:grid-cols-[4fr_4fr_1fr_4fr] gap-4 mb-8" style="width: max-content;">
        <!-- Original Poem Column (4fr width) -->
        <div class="flex flex-col bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200 relative min-h-[93px]">
                <div class="absolute top-4 right-4 text-right">
                    <div class="mb-1">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-700">{{ poem.source_language }}</span>
                    </div>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-700">Original</span>
                </div>
                <h2 class="text-lg font-medium text-gray-900 mb-1 pr-16">
                    <span class="w-6 h-6 bg-gray-500 text-white rounded-full flex items-center justify-center text-xs font-medium mr-2 inline-flex">O</span>
                    {{ poem.poem_title }}
                </h2>
                <p class="text-sm text-gray-600 mb-2">by {{ poem.poet_name }}</p>
            </div>
            <!-- Scrollable Content -->
            <div class="sync-scroll flex-grow overflow-y-auto">
                <div class="poetry-text-container p-6 text-gray-800 leading-relaxed font-serif text-base whitespace-pre">{{ poem.original_text | strip_leading_spaces }}</div>
            </div>
            <!-- Footer -->
            <div class="px-6 pb-6 min-h-[100px] flex flex-col justify-center">
                <div class="pt-4 border-t border-gray-200">
                    <div class="flex items-start justify-between text-sm w-full">
                        <div class="flex-shrink-0 mr-4">
                            <span class="text-gray-500 text-xs">ID:</span><br>
                            <span class="text-gray-500 text-xs break-all max-w-[200px]">{{ poem.id }}</span>
                        </div>
                        <div class="invisible text-sm font-medium whitespace-nowrap">Original Poem</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Initial Translation Column (4fr width) -->
        <div id="initial-translation-col" class="flex flex-col bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden">
            <!-- Content will be dynamically generated by JavaScript -->
        </div>

        <!-- Elegant Connector Column (1fr width) -->
        <div class="flex items-center justify-center">
            <div class="w-full h-full relative flex items-center justify-center">
                <!-- Vertical dashed line -->
                <div class="absolute top-0 h-full w-px bg-repeat-y bg-center" style="background-image: linear-gradient(to bottom, #cbd5e1 60%, transparent 40%); background-size: 1px 10px;"></div>
                <!-- Clickable Icon with Label -->
                <div class="z-10 flex flex-col items-center justify-center space-y-2">
                    <button id="editor-review-btn" title="View Editor Review" class="group flex items-center justify-center w-12 h-12 bg-white border-2 border-orange-300 rounded-full shadow-lg hover:shadow-xl hover:border-orange-500 transition-all duration-300 hover:scale-110">
                        <svg class="w-6 h-6 text-orange-500 group-hover:text-orange-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"/>
                        </svg>
                    </button>
                    <span class="text-xs font-semibold text-orange-700 bg-orange-50 px-2 py-1 rounded-full border border-orange-200 shadow-sm whitespace-nowrap">Editor Review</span>
                </div>
            </div>
        </div>

        <!-- Final Translation Column (4fr width) -->
        <div id="revised-translation-col" class="flex flex-col bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden">
            <!-- Content will be dynamically generated by JavaScript -->
        </div>
    </div>
</div>

    <!-- Translation Notes Placeholder Block -->
    <div id="translation-notes-placeholder" class="mt-8 bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900 mb-1">
                <span class="w-6 h-6 bg-indigo-500 text-white rounded-full flex items-center justify-center text-xs font-medium mr-2 inline-flex">N</span>
                Translation Notes
            </h3>
        </div>
        
        <!-- Content -->
        <div class="p-6">
            <div class="text-center text-gray-500 italic text-sm">
                Click 'View Notes' and 'Editor Review' buttons above to display 'Initial Translation Notes', 'Revised Translation Notes' and 'Editor's Suggestions' here.
            </div>
        </div>
    </div>

<div id="notes-display-container" class="hidden mb-8">
    <div class="bg-white shadow-lg rounded-lg border border-gray-100 overflow-hidden">
        <!-- Notes Header -->
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <div class="flex items-center justify-between">
                <h3 id="notes-title" class="text-lg font-semibold text-gray-900">Notes</h3>
                <button id="close-notes-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>
        <!-- Notes Content -->
        <div id="notes-content" class="p-6">
            <!-- Dynamic notes content will be inserted here -->
        </div>
    </div>
</div>

<!-- Performance Summary for Wide Layout -->
{% if translation.translator_type.lower() == 'ai' and workflow_data and workflow_data.total_tokens %}
<aside class="mt-12 max-w-7xl mx-auto">
    <div class="bg-white shadow-lg rounded-lg p-6 border border-gray-100">
        <h3 class="text-lg font-bold text-gray-900 mb-4">Performance Summary</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="text-center">
                <div class="text-2xl font-bold text-primary-600">{{ workflow_data.total_tokens or 0 }}</div>
                <div class="text-sm text-gray-600">Total Tokens</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600">¥{{ "%.2f"|format(workflow_data.total_cost or 0) }}</div>
                <div class="text-sm text-gray-600">Total Cost</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600">{{ "%.1f"|format(workflow_data.total_duration or 0) }}s</div>
                <div class="text-sm text-gray-600">Total Time</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-purple-600">{{ workflow_steps|length or 0 }}</div>
                <div class="text-sm text-gray-600">Workflow Steps</div>
            </div>
        </div>
    </div>
</aside>
{% endif %}

<script>
// Translation Notes Page JavaScript

// Workflow data for Layout 2 - safely passed from Jinja
{% if translation.translator_type.lower() == 'ai' and workflow_steps %}
    {% set initial_step = workflow_steps | selectattr('step_type', 'equalto', 'initial_translation') | first %}
    {% set editor_step = workflow_steps | selectattr('step_type', 'equalto', 'editor_review') | first %}
    {% set revised_step = workflow_steps | selectattr('step_type', 'equalto', 'revised_translation') | first %}

    window.layout2Data = {
        initialStep: {{ initial_step | tojson | safe }},
        editorStep: {{ editor_step | tojson | safe }},
        revisedStep: {{ revised_step | tojson | safe }},
        poemTitle: {{ poem.poem_title | tojson | safe }},
        poetName: {{ poem.poet_name | tojson | safe }},
        translationId: {{ translation.id | tojson | safe }},
        targetLanguage: {{ translation.target_language | tojson | safe }}
    };
{% else %}
    window.layout2Data = null;
{% endif %}

document.addEventListener('DOMContentLoaded', function() {
    initializeLayoutToggle();
    initializeProgressNavigation();
    initializeScrollTracking();
    initializeKeyboardNavigation();
    initializeDeepLinking();
    initializeLayoutInteractions(); // Layout-agnostic initialization
});

// --- LAYOUT TOGGLE ---
function initializeLayoutToggle() {
    const layout1Btn = document.getElementById('layout1-btn');
    const layout2Btn = document.getElementById('layout2-btn');
    if (layout1Btn) layout1Btn.addEventListener('click', () => switchToLayout(1));
    if (layout2Btn) layout2Btn.addEventListener('click', () => switchToLayout(2));
}

function switchToLayout(layoutNumber) {
    const layout1 = document.getElementById('layout1');
    const layout2 = document.getElementById('layout2');
    const layout1Btn = document.getElementById('layout1-btn');
    const layout2Btn = document.getElementById('layout2-btn');

    console.log('Switching to layout:', layoutNumber);
    console.log('Before - Layout1 hidden:', layout1?.classList.contains('hidden'));
    console.log('Before - Layout2 hidden:', layout2?.classList.contains('hidden'));

    // Ensure both layouts are properly hidden first
    if (layout1) layout1.classList.add('hidden');
    if (layout2) layout2.classList.add('hidden');

    if (layoutNumber === 1) {
        console.log('Showing Layout 1 (Long)');
        layout1.classList.remove('hidden');
        layout2.classList.add('hidden');
        layout1Btn.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
        layout1Btn.classList.remove('text-indigo-700');
        layout2Btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
        layout2Btn.classList.add('text-indigo-700');
    } else {
        console.log('Showing Layout 2 (Wide)');
        layout2.classList.remove('hidden');
        layout1.classList.add('hidden');
        layout2Btn.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
        layout2Btn.classList.remove('text-indigo-700');
        layout1Btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
        layout1Btn.classList.add('text-indigo-700');
    }

    hideNotesDisplay();

    console.log('After - Layout1 hidden:', layout1?.classList.contains('hidden'));
    console.log('After - Layout2 hidden:', layout2?.classList.contains('hidden'));
}

// --- LAYOUT-AGNOSTIC INTERACTIONS ---
function initializeLayoutInteractions() {
    // Initialize layout-2-specific interactions if elements exist
    initializeLayout2Elements();

    // Initialize layout-1-specific interactions if elements exist
    initializeLayout1Elements();

    // Initialize common interactions (notes, buttons, etc.)
    initializeCommonInteractions();
}

function initializeLayout2Elements() {
    if (!window.layout2Data) return;

    const initialCol = document.getElementById('initial-translation-col');
    const revisedCol = document.getElementById('revised-translation-col');

    // Populate columns with data if elements exist
    if (initialCol) {
        initialCol.innerHTML = generateColumnHTML(window.layout2Data.initialStep, 'blue', 1, 'Initial');
        initialCol.addEventListener('click', e => {
            if (e.target.closest('.notes-btn')) {
                showNotes('initial', window.layout2Data.initialStep.notes);
            }
        });
    }

    if (revisedCol) {
        revisedCol.innerHTML = generateColumnHTML(window.layout2Data.revisedStep, 'green', 3, 'Final');
        revisedCol.addEventListener('click', e => {
            if (e.target.closest('.notes-btn')) {
                showNotes('revised', window.layout2Data.revisedStep.notes);
            }
        });
    }
}

function initializeLayout1Elements() {
    // Add layout-1-specific initialization here if needed
    // Currently, Layout 1 doesn't require additional JavaScript initialization
    // as it uses server-side rendered content
}

function initializeCommonInteractions() {
    // Initialize common elements that work across both layouts
    const editorBtn = document.getElementById('editor-review-btn');
    const closeNotesBtn = document.getElementById('close-notes-btn');

    if (editorBtn) {
        editorBtn.addEventListener('click', () => showNotes('editor', window.layout2Data.editorStep.content));
    }

    if (closeNotesBtn) {
        closeNotesBtn.addEventListener('click', hideNotesDisplay);
    }
}

function generateColumnHTML(stepData, color, stepNum, stepLabel) {
    if (!stepData) {
        return `<div class="p-6 text-center text-gray-400 flex items-center justify-center h-full">
            <div>
                <svg class="mx-auto h-12 w-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <p>${stepLabel} Translation Not Available</p>
            </div>
        </div>`;
    }

      const translatedTitle = stepData.translated_title || `${stepLabel} Translation`;
    const translatedPoet = stepData.translated_poet_name || 'Translated';
    const notesLink = stepData.notes ?
        `<a href="#" class="notes-btn inline-flex items-center text-sm text-${color}-600 hover:text-${color}-800 font-medium whitespace-nowrap">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            View Notes
        </a>` : '';

    return `
        <div class="bg-gradient-to-r from-${color}-50 to-${color}-100 px-6 py-4 border-b border-gray-200 relative min-h-[93px]">
            <div class="absolute top-4 right-4 text-right">
                <div class="mb-1">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-${color}-200 text-${color}-800">${window.layout2Data.targetLanguage}</span>
                </div>
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-${color}-200 text-${color}-800">${stepLabel} Translation</span>
            </div>
            <h2 class="text-lg font-medium text-gray-900 mb-1 pr-16">
                <span class="w-6 h-6 bg-${color}-500 text-white rounded-full flex items-center justify-center text-xs font-medium mr-2 inline-flex">${stepNum}</span>
                ${translatedTitle}
            </h2>
            <p class="text-sm text-gray-600 mb-2">by ${translatedPoet}</p>
        </div>
        <div class="sync-scroll flex-grow overflow-y-auto">
            <div class="poetry-text-container p-6 text-gray-800 leading-relaxed font-serif text-base whitespace-pre">${stepData.content.trimStart()}</div>
        </div>
        <div class="px-6 pb-6 min-h-[100px] flex flex-col justify-center">
            <div class="pt-4 border-t border-gray-200">
                <div class="flex items-start justify-between text-sm w-full">
                    <div class="flex-shrink-0 mr-4">
                        <span class="text-gray-500 text-xs">ID:</span><br>
                        <span class="text-gray-500 text-xs break-all max-w-[200px]">${window.layout2Data.translationId}</span>
                    </div>
                    <div class="flex-shrink-0 ml-auto">${notesLink}</div>
                </div>
            </div>
        </div>
    `;
}

function showNotes(type, content) {
    const notesContainer = document.getElementById('notes-display-container');
    const notesTitleEl = document.getElementById('notes-title');
    const notesContentEl = document.getElementById('notes-content');

    if (!notesContainer || !notesTitleEl || !notesContentEl) return;

    // Get step data for metrics
    let stepData = null;
    if (type === 'initial' && window.layout2Data.initialStep) {
        stepData = window.layout2Data.initialStep;
    } else if (type === 'editor' && window.layout2Data.editorStep) {
        stepData = window.layout2Data.editorStep;
    } else if (type === 'revised' && window.layout2Data.revisedStep) {
        stepData = window.layout2Data.revisedStep;
    }

    // For Editor Review, ensure we have all metrics including cost
    if (type === 'editor' && stepData && !stepData.cost && window.layout2Data.initialStep && window.layout2Data.revisedStep) {
        // If editor step doesn't have cost data, we can calculate it or use placeholder
        // For now, we'll ensure cost is displayed if available in the workflow
        stepData.cost = window.layout2Data.initialStep.cost || window.layout2Data.revisedStep.cost || null;
    }

    // Build metrics HTML if step data is available
    let metricsHtml = '';
    if (stepData) {
        const metrics = [];
        if (stepData.tokens_used) {
            metrics.push(`<span class="flex items-center text-gray-600 text-xs">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                </svg>
                ${stepData.tokens_used} tokens
            </span>`);
        }
        if (stepData.duration_seconds) {
            metrics.push(`<span class="flex items-center text-gray-600 text-xs">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                ${parseFloat(stepData.duration_seconds).toFixed(1)}s
            </span>`);
        }
        if (stepData.cost) {
            metrics.push(`<span class="flex items-center text-gray-600 text-xs">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3-2-1.343-2-3-2zm0 8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v2m0-6h.01M16 13h.01"/>
                </svg>
                ¥${parseFloat(stepData.cost).toFixed(6)}
            </span>`);
        }

        if (metrics.length > 0) {
            metricsHtml = `<div class="flex flex-wrap gap-4 mb-4 pb-4 border-b border-gray-200 justify-end">${metrics.join('')}</div>`;
        }
    }

    if (!content) {
        content = '<p class="text-gray-500 italic">No notes available for this step.</p>';
    } else {
        content = `<div class="prose prose-sm max-w-none text-sm text-gray-700 leading-relaxed">${content.replace(/\n/g, '<br>')}</div>`;
    }

    // Combine metrics and content
    const fullContent = metricsHtml + content;

    const titles = {
        initial: 'Initial Translator Notes',
        editor: 'Editor Review',
        revised: 'Final Revision Notes'
    };

    notesTitleEl.textContent = titles[type];
    notesContentEl.innerHTML = fullContent;
    notesContainer.classList.remove('hidden');
    notesContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function hideNotesDisplay() {
    const notesContainer = document.getElementById('notes-display-container');
    if (notesContainer) {
        notesContainer.classList.add('hidden');
    }
}

// --- UTILITY FUNCTIONS (layout-agnostic) ---
function initializeSyncScroll() {
    // Make it layout-agnostic - find all sync-scroll elements in any layout
    const scrollableElements = document.querySelectorAll('.sync-scroll');
    if (scrollableElements.length === 0) return;

    let isSyncing = false;
    scrollableElements.forEach(element => {
        element.addEventListener('scroll', event => {
            if (isSyncing) return;
            isSyncing = true;
            const sourceElement = event.target;
            const scrollPercentage = sourceElement.scrollTop / (sourceElement.scrollHeight - sourceElement.clientHeight);

            scrollableElements.forEach(targetElement => {
                if (targetElement !== sourceElement) {
                    const targetScrollableHeight = targetElement.scrollHeight - targetElement.clientHeight;
                    if (targetScrollableHeight > 0) {
                        targetElement.scrollTop = targetScrollableHeight * scrollPercentage;
                    }
                }
            });
            requestAnimationFrame(() => { isSyncing = false; });
        });
    });
}

function initializeProgressNavigation() {
    window.addEventListener('scroll', updateProgressNavigation);
    updateProgressNavigation();
}

function updateProgressNavigation() {
    const workflowSteps = document.querySelectorAll('.workflow-step-card');
    const progressBar = document.getElementById('workflow-progress-bar');
    if (workflowSteps.length === 0 || !progressBar) return;

    const scrollPosition = window.scrollY;
    const windowHeight = window.innerHeight;
    const documentHeight = document.documentElement.scrollHeight;
    const progress = Math.min((scrollPosition / (documentHeight - windowHeight)) * 100, 100);
    progressBar.style.width = `${progress}%`;
}

function initializeScrollTracking() {
    let ticking = false;
    function updateScrollState() {
        updateProgressNavigation();
        ticking = false;
    }
    window.addEventListener('scroll', function() {
        if (!ticking) {
            requestAnimationFrame(updateScrollState);
            ticking = true;
        }
    });
}

function initializeKeyboardNavigation() {
    document.addEventListener('keydown', function(e) {
        switch(e.key) {
            case 'ArrowDown':
                if (e.altKey) {
                    e.preventDefault();
                    // Navigate to next step
                }
                break;
            case 'ArrowUp':
                if (e.altKey) {
                    e.preventDefault();
                    // Navigate to previous step
                }
                break;
        }
    });
}

function initializeDeepLinking() {
    const hash = window.location.hash.substring(1);
    if (hash && hash.startsWith('step-')) {
        const stepType = hash.replace('step-', '');
        setTimeout(() => {
            const stepElement = document.getElementById(`step-${stepType}`);
            if (stepElement) {
                stepElement.scrollIntoView({ behavior: 'smooth' });
            }
        }, 100);
    }
}
</script>

<style>
.poetry-text-container {
  width: max-content;
  min-width: 100%;
}

/* --- NEW AND FINAL RULE FOR AUTO-ADAPTIVE CENTERING --- */
#layout2 {
  width: 100vw;
  position: relative;
  left: 50%;
  transform: translateX(-50%);

  /* This part is new: it makes the breakout container a centering grid */
  display: grid;
  place-items: center;
}

/* --- FORCE HIDDEN LAYOUTS TO STAY HIDDEN --- */
#layout1.hidden,
#layout2.hidden {
  display: none !important;
  position: static !important;
  left: auto !important;
  transform: none !important;
}

/* --- HIDE TRANSLATION NOTES PLACEHOLDER IN LAYOUT 1 (LONG LAYOUT) --- */
/* When Layout 1 is visible (not hidden), hide the placeholder */
#layout1:not(.hidden) ~ #translation-notes-placeholder {
  display: none !important;
}

/* When Layout 2 is hidden, hide the placeholder */
#layout2.hidden ~ #translation-notes-placeholder {
  display: none !important;
}

/* Show placeholder only when Layout 2 is visible and Layout 1 is hidden */
#layout2:not(.hidden) ~ #translation-notes-placeholder {
  display: block !important;
}

.sync-scroll {
  /* Scrollbar styling for webkit browsers */
  scrollbar-width: thin;
  scrollbar-color: #cbd5e1 #f1f5f9;
}

.sync-scroll::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

.sync-scroll::-webkit-scrollbar-track {
  background: #f1f5f9;
}

.sync-scroll::-webkit-scrollbar-thumb {
  background-color: #cbd5e1;
  border-radius: 3px;
}

.sync-scroll::-webkit-scrollbar-thumb:hover {
  background-color: #94a3b8;
}
</style>
{% endblock %}